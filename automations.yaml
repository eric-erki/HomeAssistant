#  Set the Air conditioner mode when selected
- id: setmyairmodeselector
  alias: Set MyAir Mode Selector
  initial_state: True
  trigger:
    platform: state
    entity_id: sensor.myair_mode
  action:
    service: input_select.select_option
    entity_id: input_select.myair_modeselect
    data_template:
      option: '{{ states.sensor.myair_mode.state }}'

- id: setmyairacmode
  alias: Set MyAir AC mode
  initial_state: True
  trigger:
    entity_id: input_select.myair_modeselect
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22mode%22:%22{{ states.input_select.myair_modeselect.state }}%22%7D%7D%7D'

#  Set the Air conditioner fan selection when selected
- id: setmyairfanselector
  alias: Set MyAir Fan Selector
  initial_state: True
  trigger:
    platform: state
    entity_id: sensor.myair_fanspeed
  action:
    service: input_select.select_option
    entity_id: input_select.myair_fanselect
    data_template:
      option: '{{ states.sensor.myair_fanspeed.state }}'
- id: setmyairacfan
  alias: Set MyAir AC fan
  initial_state: True
  trigger:
    entity_id: input_select.myair_fanselect
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22fan%22:%22{{ states.input_select.myair_fanselect.state }}%22%7D%7D%7D'

#  Set the Air conditioner temperature when selected
- id: setmyairtempselector
  alias: Set MyAir Temp Selector
  initial_state: True
  trigger:
    platform: state
    entity_id: sensor.myair_settemp
  action:
    service: input_number.set_value
    entity_id: input_number.myair_inputsettemp
    data_template:
      value: '{{ states.sensor.myair_settemp.state }}'
- id: setmyairacTemp
  alias: Set MyAir AC Temp
  initial_state: True
  trigger:
    entity_id: input_number.myair_inputsettemp
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22setTemp%22:%22{{ states.input_number.myair_inputsettemp.state }}%22%7D%7D%7D'

#  Set the Air conditioner air flow when selected
- id: setmyairzoneairflow
  alias: Set MyAir Zone Airflow
  trigger:
    entity_id: input_number.myair_zone1,input_number.myair_zone2,input_number.myair_zone3,input_number.myair_zone4,input_number.myair_zone5,input_number.myair_zone6
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22zones%22:%7B%22{{ trigger.entity_id|replace("input_number.myair_zone","z0") }}%22:%7B%22value%22:%22{{ trigger.to_state.state | int }}%22%7D%7D%7D%7D'
- id: setmyairzoneflowselector
  alias: Set MyAir Zone Airflow Selector
  trigger:
    - platform: state
      entity_id: sensor.myair_zone1_cover,sensor.myair_zone2_cover,sensor.myair_zone3_cover,sensor.myair_zone4_cover,sensor.myair_zone5_cover,sensor.myair_zone6_cover
  action:
    service: input_number.set_value
    data_template:
      entity_id: '{{ trigger.entity_id | replace("sensor.","input_number.") | replace("_cover","") }}'
      value: >
        {% if trigger.entity_id == "sensor.myair_zone1_cover" %}
          {{ states.sensor.myair_zone1_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone2_cover" %}
          {{ states.sensor.myair_zone2_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone3_cover" %}
          {{ states.sensor.myair_zone3_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone4_cover" %}
          {{ states.sensor.myair_zone4_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone5_cover" %}
          {{ states.sensor.myair_zone5_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone6_cover" %}
          {{ states.sensor.myair_zone6_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone7_cover" %}
          {{ states.sensor.myair_zone7_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone8_cover" %}
          {{ states.sensor.myair_zone8_cover.state|float }}
        {% elif trigger.entity_id == "sensor.myair_zone9_cover" %}
          {{ states.sensor.myair_zone9_cover.state|float }}
        {% endif %}

#  Set the Air conditioner start timer  when selected
- id: setmyairstarttimer
  alias: Set MyAir Start Timer
  initial_state: True
  trigger:
    entity_id: input_number.myair_starttimer
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22countDownToOn%22:%22{{ states.input_number.myair_starttimer.state }}%22%7D%7D%7D'

#  Set the Air conditioner end timer when selected        
- id: setmyairstoptimer
  alias: Set MyAir Stop Timer
  initial_state: True
  trigger:
    entity_id: input_number.myair_stoptimer
    platform: state
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22countDownToOff%22:%22{{ states.input_number.myair_stoptimer.state }}%22%7D%7D%7D'

#Set the Air conditioner time when selected  
- id: setmyairzonetimeselector
  alias: Set MyAir Zone Timer Selector
  trigger:
    - platform: state
      entity_id: sensor.myair_start_timer,sensor.myair_stop_timer
  action:
    service: input_number.set_value
    data_template:
      entity_id: '{{ trigger.entity_id | replace("sensor.","input_number.") | replace("_timer","timer") }}'
      value: >
        {% if trigger.entity_id == "sensor.myair_start_timer" %}
          {{ states.sensor.myair_start_timer.state|float }}
        {% elif trigger.entity_id == "sensor.myair_stop_timer" %}
          {{ states.sensor.myair_stop_timer.state|float }}
        {% endif %}

# Set Air conditioner stop timer to 90 mins when it is turned on
- id: setmyairstoptimerbyswitch
  alias: Set Air conditioner stop timer to 90 mins when it is turned on
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        seconds: 60
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22countDownToOff%22:%2290%22%7D%7D%7D'

# Set MyAir Stop Timer to 90 when air con Switch is turned on but stop timer still not set (second try)
- id: setmyairstoptimerbyswitchstry2
  alias: Set MyAir Stop Timer to 90 when air con Switch is turned on but stop timer still not set
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        seconds: 120
  condition:
    condition: numeric_state
    entity_id: sensor.myair_stop_timer
    equal: 0
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22countDownToOff%22:%2290%22%7D%7D%7D'


# Reset Air Conditioner Stop Timer to 0 when the air conditioner is turned off    
- id: resetmyairstoptimerbyswitch
  alias: Reset Air Conditioner Stop Timer to 0 when the air conditioner is turned off  
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'on'
      to: 'off'
      for:
        seconds: 30
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22countDownToOff%22:%220%22%7D%7D%7D'

# Turn on the Air Conditioner on Weekdays at 06:15AM if the kitchen temperature is below 19C
- id: turnonairconbelow18c
  alias: Turn on the Air Conditioner on Weekdays at 06:15AM if the kitchen temperature is below 19C
  initial_state: True
  trigger:
    - platform: time
      at: '06:15:00'
  condition:
    condition: and
    conditions: 
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
      - condition: state
        entity_id: input_boolean.aircon_on_auto
        state: 'on'
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.6_in_1_multisensor_temperature_2_252
        below: 19
  action:
    - service : switch.turn_on
      entity_id: switch.air_conditioner

# Alert when Air conditioner is left on for more than 4 hours. 
- id: myairruntimealert4hrs
  alias: Alert when Air conditioner is left on for more than 4 hours
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        hours: 4
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Air Conditioner is running for more than 4 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 4 hours'
    - service: notify.sendgrid
      data_template:
        title: 'Air Conditioner is running for more than 4 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 4 hours'

# Alert when Air conditioner is left On for more than 5 hours. 
- id: myairruntimealert5hrs
  alias: Alert when Air conditioner is left On for more than 5 hours
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        hours: 5
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Air Conditioner is running for more than 5 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 5 hours'
    - service: notify.sendgrid
      data_template:
        title: 'Air Conditioner is running for more than 5 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 5 hours'

# Alert when Air conditioner is left On for more than 6 hours. 
- id: myairruntimealert6hrs
  alias: Alert when Air conditioner is left On for more than 6 hours
  initial_state: True
  trigger:
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        hours: 6
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Air Conditioner is running for more than 6 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 6 hours'
    - service: notify.sendgrid
      data_template:
        title: 'Air Conditioner is running for more than 6 hours {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner is running for more than 6 hours'

# Alert and Turn off air conditioner if it is left On when the house alarm is on (After leaving home)
- id: alertwhenairconisonafterleavinghome
  alias: Alert and Turn off air conditioner if it is left On when the house alarm is on (After leaving home)
  initial_state: True
  trigger:
    - platform: state
      entity_id: switch.housealarm
      to: 'on'
      for:
        minutes: 2
  condition:
    condition: state
    entity_id: sensor.myair_state
    state: 'on'
  action:
    - service: shell_command.myair_setcmd
      data_template:
        json: '%7B%22ac1%22:%7B%22info%22:%7B%22state%22:%22off%22%7D%7D%7D'
    - service: notify.pushbullet
      data_template:
        title: 'Air Conditioner was running when the house alarm was turned on {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner was running when the house alarm was turned on. It was turned off automatically.'
    - service: notify.sendgrid
      data_template:
        title: 'Air Conditioner was running when the house alarm was turned on {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  'Air Conditioner was running when the house alarm was turned on. It was turned off automatically.'


# TEST - plex seven news play - not working and still trialing
- id: plexplay
  alias: plex seven news play
  initial_state: True
  trigger:
    - platform: state
      entity_id: switch.myair_zone6
      to: 'on'
  action:
    - service: media_player.play_media
      entity_id: media_player.living_room
      data:
        media_content_id: '{ \"library_name\" : \"TV Shows\", \"show_name\" : \"Seven News\", \"season_number\" : 2019, \"episode_number\" : \"04-23\", \"shuffle\": \"0\" }'
        media_content_type: EPISODE

# Send Alerts from Xiaomi Motion and Door sensors when the house is Armed
- id: xiaomi_alerts
  alias: Send Alerts from Xiaomi Motion and Door sensors when the house is Armed
  trigger: 
    # Kitchen-M2  
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002742898
      to: 'on'
    # Bath-M
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001e0ac8e
      to: 'on'
    # Living-M
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002c716b6
      to: 'on'
    # Main Door
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002739295
      to: 'on'
    # Garage-M2
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002c716d7
      to: 'on'
    # Loundry Door
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002ca3100
      to: 'on'
    # Office-M2
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b7ec00
      to: 'on'
    # Master-M2
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b7f1e8
      to: 'on'
    # Alfresco-M
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b5eecd
      to: 'on'
    # Garage Entry door
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d00033a7262
      to: 'on'
  condition:
    condition: state
    entity_id: switch.housealarm
    state: 'on'
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Motion Detected {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  '{{ states[trigger.entity_id.split(".")[0]][ trigger.entity_id.split(".")[1]].name }}  has triggered'
    - service: notify.sendgrid
      data_template:
        title: 'Motion Detected {{now().strftime("%Y%m%d-%H%M%S")}}'
        message:  '{{ states[trigger.entity_id.split(".")[0]][ trigger.entity_id.split(".")[1]].name }}  has triggered'

# Turn on the Bath Light when there is motion
- id: bathlighton
  alias: Turn on Bath Light when there is motion
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001e0ac8e
      to: 'on'
  condition:
    condition: numeric_state
    entity_id: sensor.illumination_158d0001e0ac8e
    below: 30
  action:
    - service: homeassistant.turn_on
      entity_id:  light.bath_light_132

# Turn off the Bath Light when there's no Motion in shower and Bathroom
- id: bathlightoff
  alias: Turn off Bath Light when there is no more motion
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0001e0ac8e
      to: 'off'
    - platform: state
      entity_id: binary_sensor.m_bed_room_m_33
      to: 'off'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: binary_sensor.motion_sensor_158d0002c6382d
        state: 'off'
      - condition: state
        entity_id: binary_sensor.motion_sensor_158d0001e0ac8e
        state: 'off'
      - condition: state
        entity_id: binary_sensor.m_bed_room_m_33
        state: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.bath_light_132

# Turn on the Pantry Light when the door open
- id: pantrylighton
  alias: Turn on the Pantry Light when the door Open
  trigger: 
    - platform: state
      entity_id: binary_sensor.pantry_door_18
      to: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id:  light.pantry_light

# Turn off the pantry light when the door close
- id: pantrylightoff
  alias: Turn off the Pantry Light when the door close
  trigger: 
    - platform: state
      entity_id: binary_sensor.pantry_door_18
      to: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.pantry_light

# Turn off the Pantry Light when the door open and left for more than 2 minutes
- id: pantrylightofftimer
  alias: Turn off the Pantry Light when the door open and left for more than 2 minutes
  trigger: 
    - platform: state
      entity_id: binary_sensor.pantry_door_18
      to: 'on'
      for:
        minutes: 2
  action:
    - service: homeassistant.turn_off
      entity_id:  light.pantry_light

# Turn on the garage light then there is motion
- id: garagelighton
  alias: Turn on Garage Light when there is motion
  trigger: 
    - platform: state
      entity_id: group.garage_motion
      to: 'on'
  condition:
    condition: numeric_state
    entity_id: sensor.garage_sensor_l_48
    below: 30
  action:
    - service: homeassistant.turn_on
      entity_id:  light.garage_light

# Turn off the garage light then there is no motion
- id: garagelightoff
  alias: Turn off Garage Light when there is no motion
  trigger: 
    - platform: state
      entity_id: group.garage_motion
      to: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.garage_light

# Turn off the garage light if it was one for more than 60 minutes
- id: garagelightoff60min
  alias: Turn off the garage light if it was one for more than 60 minutes
  trigger: 
    - platform: state
      entity_id: light.garage_light
      to: 'on'
      for: 
        minutes: 60
  action:
    - service: homeassistant.turn_off
      entity_id:  light.garage_light


# Turn on the Bath strip when there is motion in Master bedroom
- id: bathstripon
  alias: Turn on Bath strip when there is motion in Master bedroom
  trigger: 
    - platform: state
      entity_id: binary_sensor.m_bed_room_m_33
      to: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id:  light.bath_stripe

# Turn off the Bath strip when there's no Motion in master bedroom
- id: bathstripoff
  alias: Turn off Bath Strip when there is no more motion
  trigger: 
    - platform: state
      entity_id: binary_sensor.m_bed_room_m_33
      to: 'off'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.bath_stripe

# Alert if the Laundry door was left open for more than 10 minutes
- id: laundrydoor10mins
  alias: Alert if the Laundry door was left open for more than 10 minutes
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002ca3100
      to: 'on'
      for:
        minutes: 10
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Laundry Door was left open for more than 10 minutes -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Laundry door was left open for more than 10 minutes'
    - service: notify.sendgrid
      data_template:
        title: 'Laundry Door was left open for more than 10 minutes - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Laundry door was left open for more than 10 minutes'

# Alert if the Laundry door was left open for more than 60 minutes
- id: laundrydoor120mins
  alias: Alert if the Laundry door was left open for more than 60 minutes
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002ca3100
      to: 'on'
      for:
        minutes: 120
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Laundry Door was left open for more than 120 minutes -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Laundry door was left open for more than 120 minutes'
    - service: notify.sendgrid
      data_template:
        title: 'Laundry Door was left open for more than 120 minutes - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Laundry door was left open for more than 120 minutes'

# Alert if any door was left open everyday at 10pm
- id: dailydooropenalert
  alias: Alert if any door was left open everyday at 10pm
  trigger: 
    - platform: time
      at: '22:00:00'
  condition:
    condition: or
    conditions:
        # Main Door
      - condition: state
        entity_id: binary_sensor.door_window_sensor_158d0002739295
        state: 'on'
        # Laundry Door
      - condition: state
        entity_id: binary_sensor.door_window_sensor_158d0002ca3100
        state: 'on'
        # Garage Door
      - condition: state
        entity_id: binary_sensor.door_window_sensor_158d0002c0e236
        state: 'on'
        # Pantry Door
      - condition: state
        entity_id: binary_sensor.pantry_door_18
        state: 'on' 
        # Garage Entry Door
      - condition: state
        entity_id: binary_sensor.door_window_sensor_158d00033a7262
        state: 'on' 
  action:
    - service: notify.pushbullet
      data_template:
        title: '{{ [condition.entity_id.split(".")[1]].name  }} Door was left open at 10:00pm today -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  '{{ [condition.entity_id.split(".")[1]].name  }} Door was left open at 10:00pm today -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
    - service: notify.sendgrid
      data_template:
        title: '{{ [condition.entity_id.split(".")[1]].name  }} Door was left open at 10:00pm today -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  '{{ [condition.entity_id.split(".")[1]].name  }} Door was left open at 10:00pm today -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'



# Alert if the Garage door was left open for more than 10 minutes
- id: garagedoor10mins
  alias: Alert if the Garage door was left open for more than 10 minutes
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002c0e236
      to: 'on'
      for:
        minutes: 10
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Garage Door was left open for more than 10 minutes -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Garage door was left open for more than 10 minutes'
    - service: notify.sendgrid
      data_template:
        title: 'Garage Door was left open for more than 10 minutes - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Garage door was left open for more than 10 minutes'

# Alert if the Garage door was left open for more than 60 minutes
- id: garagedoor60mins
  alias: Alert if the Garage door was left open for more than 60 minutes
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002c0e236
      to: 'on'
      for:
        minutes: 60
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Garage Door was left open for more than 120 minutes -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Garage door was left open for more than 120 minutes'
    - service: notify.sendgrid
      data_template:
        title: 'Garage Door was left open for more than 120 minutes - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Garage door was left open for more than 120 minutes'


# Turn on the Front Outdoor light for 2 mins then there the garage door open
- id: frontoutdoorgaragelight
  alias: Turn on the Front Outdoor light for 2 mins then there the garage door open
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0002c0e236
      to: 'on'
      for: 
        seconds: 2
  condition:
    condition: state
    entity_id: sun.sun
    state: 'below_horizon'
  action:
    - service : script.turn_on
      entity_id: script.garagelight

# Turn on house alarm based on device tracker - Arm when every one is out of the house.
- id: turnonhousealarmbasedondevicetracker
  alias: Turn on house alarm based on device tracker
  trigger: 
    - platform: state
      entity_id: device_tracker.sameera_oneplus
      to: 'not_home'
    - platform: state
      entity_id: device_tracker.madhushi_iphone
      to: 'not_home'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: device_tracker.sameera_oneplus
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.madhushi_iphone
        state: 'not_home'
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: input_boolean.housealarm_auto
        state: 'on'
  action:
    - service : switch.turn_on
      entity_id: switch.housealarm

# Turn off house alarm based on device tracker - Unarm when anyone is back at home
- id: turnoffhousealarmbasedondevicetracker
  alias: Turn off house alarm based on device tracker
  trigger: 
    - platform: state
      entity_id: device_tracker.sameera_oneplus
      to: 'home'
    - platform: state
      entity_id: device_tracker.madhushi_iphone
      to: 'home'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.housealarm_auto
        state: 'on'
      - condition: state
        entity_id: switch.housealarm
        state: 'on'
      - condition: or
        conditions:
        - condition: state
          entity_id: device_tracker.sameera_oneplus
          state: 'home'
        - condition: state
          entity_id: device_tracker.madhushi_iphone
          state: 'home'
  action:
    - service : switch.turn_off
      entity_id: switch.housealarm

# Toggle Alfresco Music Play with Alfresco Xiaomi push button
- id: togglealfrescomusicplaypushbutton
  alias: Toggle Alfresco Music Play with Alfresco Xiaomi push button
  trigger: 
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002860904
      click_type: single
  condition:
    condition: state
    entity_id: input_boolean.alfresco_button
    state: 'on'
  action:
    service: media_player.media_play_pause
    entity_id: media_player.alfresco

# Jump to Next track in Alfresco Music Play when Alfresco Xiaomi push button double press is detected
- id: nextrackalfrescomusicplaydoublepushbutton
  alias: Jump to Next track in Alfresco Music Play when Alfresco Xiaomi push button double press is detected
  trigger: 
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002860904
      click_type: double
  condition:
    condition: state
    entity_id: input_boolean.alfresco_button
    state: 'on'
  action:
    service: media_player.media_next_track
    entity_id: media_player.alfresco

# Toggle Alfresco Automation with Alfresco Xiaomi push button long press
- id: togglealfrescoautomationpushbutton
  alias: Toggle Alfresco Automation with Alfresco Xiaomi push button long press
  trigger: 
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d0002860904
      click_type: long_click_press
  condition:
    condition: state
    entity_id: input_boolean.alfresco_button
    state: 'on'
  action:
    - service: input_boolean.toggle
      data:
        entity_id: input_boolean.alfresco_motion_music
    - service: input_boolean.toggle
      data:
        entity_id: input_boolean.alfresco_motion_light

# Turn on Alfresco Music Play with Alfresco Motion
- id: turnonalfrescomusicplaywithmotion
  alias: Turn on Alfresco Music Play with Alfresco Motion
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b5eecd
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: input_boolean.alfresco_motion_music
        state: 'on'
      - condition: time
        before: '23:59:59'
      - condition: time
        after: '08:00:00'
      - condition: state
        entity_id: switch.nightmood
        state: 'off'
  action:
    service: media_player.media_play
    entity_id: media_player.alfresco

# Turn off Alfresco Music Play with Alfresco No Motion for 3 mins
- id: turnoffalfrescomusicplaywithnomotion
  alias: Turn off Alfresco Music Play with Alfresco No Motion for 3 mins
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b5eecd
      to: 'off'
      for: 
        minutes: 3
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: input_boolean.alfresco_motion_music
        state: 'on'
      - condition: state
        entity_id: media_player.alfresco
        state: 'playing'
  action:
    service: media_player.media_pause
    entity_id: media_player.alfresco

# Turn on Alfresco light with 20% when there is motion in Alfresco
- id: turnonalfrescolightwithmotion
  alias: Turn on Alfresco light with 20% when there is motion in Alfresco
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b5eecd
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: input_boolean.alfresco_motion_light
        state: 'on'
      - condition: time
        before: '23:59:59'
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: switch.nightmood
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.illumination_158d0002b5eecd
        below: 20
  action:
    - service: light.turn_on
      data:
        entity_id: light.alfresco_light_260
        brightness_pct: 20

# Turn off the Alfresco Light when there is no motion 
- id: alfrescolightoffnomotion
  alias: Turn off the Alfresco Light when there is no motion 
  trigger: 
    - platform: state
      entity_id: binary_sensor.motion_sensor_158d0002b5eecd
      to: 'off'
      for:
        minutes: 3
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: light.alfresco_light_260
        state: 'on'
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
      - condition: state
        entity_id: input_boolean.alfresco_motion_light
        state: 'on'
  action:
    - service: light.turn_off
      entity_id: light.alfresco_light_260

# Alert if the Alfresco Sonos was playing for more than 2 hours
- id: alfrescosonos2hr
  alias: Alert if the Alfresco Sonos was playing for more than 2 hours
  trigger: 
    - platform: state
      entity_id: media_player.alfresco
      state: 'playing'
      for:
        hours: 2
  action:
    - service: media_player.media_pause
      entity_id: media_player.alfresco
    - service: notify.pushbullet
      data_template:
        title: 'Alfresco Music was playing for more than 2 hours -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Alfresco Music was playing for more than 2 hours'
    - service: notify.sendgrid
      data_template:
        title: 'Alfresco Music was playing for more than 2 hours - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Alfresco Music was playing for more than 2 hours'

# Alert and Turn off if the Alfresco Sonos was playing for more than 4 hours
- id: alfrescosonos4hrs
  alias: Alert and Turn off if the Alfresco Sonos was playing for more than 4 hours
  trigger: 
    - platform: state
      entity_id: media_player.alfresco
      state: 'playing'
      for:
        hours: 4
  action:
    - service: notify.pushbullet
      data_template:
        title: 'Alfresco Music was playing for more than 4 hours - Turned off -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Alfresco Music was playing for more than 4 hours. It was turned off'
    - service: notify.sendgrid
      data_template:
        title: 'Alfresco Music was playing for more than 4 hours - Turned off - {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  'Alfresco Music was playing for more than 4 hours. It was turned off'


# Turn on the Office light then there is motion
- id: officelightonmotion
  alias: Turn on Office Light when there is motion
  trigger: 
    - platform: state
      entity_id: group.office_motion
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: light.office_dimmer_120
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.illumination_158d0002b7ec00
        below: 20
  action:
    - service: homeassistant.turn_on
      entity_id:  light.office_dimmer_120

# Turn off the Office Light when there is no motion 
- id: officelightoff
  alias: Turn off Office Light when there is no motion 
  trigger: 
    platform: state
    entity_id: group.office_motion
    to: 'off'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: light.office_dimmer_120
        state: 'on'
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.office_dimmer_120

# Turn off the Master Light when there is no motion for more than 5 minutes
- id: masterlightoff5min
  alias: Turn off Master Light when there is no motion for more than 5 minutes
  trigger: 
    platform: state
    entity_id: group.master_motion
    to: 'off'
    for: 
      minutes: 5
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
      - condition: state
        entity_id: light.master_dimmer_123
        state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.master_dimmer_123

# Turn on the Kitchen light then there is motion based on light and sunset
- id: kitchenlightonmotion
  alias: Turn on the Kitchen light then there is motion based on light and sunset
  trigger: 
    - platform: state
      entity_id: group.kitchen_motion
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: light.kitchen_light_135
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.6_in_1_multisensor_light_2_253
        below: 25
      - condition: sun
        after: sunset
        after_offset: "-01:00:00"
      - condition: sun
        before: sunrise
        before_offset: "01:00:00"
  action:
    - service: homeassistant.turn_on
      entity_id:  light.kitchen_light_135


# Turn off the Kitchen Light when there is no motion for more than 10 minutes
- id: kitchenlightoff10min
  alias: Turn off Kitchen Light when there is no motion for more than 10 minutes
  trigger: 
    platform: state
    entity_id: group.kitchen_motion
    to: 'off'
    for: 
      minutes: 10
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
      - condition: state
        entity_id: light.kitchen_light_135
        state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id:  light.kitchen_light_135


# Turn off the Office AC Vent when there is no motion for more than 5 minutes in the office
- id: officeacoff10min
  alias: Turn off Office vent when there is no motion for more than 5 minutes
  trigger: 
    - platform: state
      entity_id: group.office_motion
      to: 'off'
      for: 
        minutes: 5
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        seconds: 90
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.zone_off_auto
        state: 'on'
      - condition: state
        entity_id: sensor.myair_state
        state: 'on'
      - condition: state
        entity_id: group.office_motion
        state: 'off'
      - condition: state
        entity_id: switch.myair_zone2
        state: 'on'
  action:
    - service: switch.turn_off
      entity_id:  switch.myair_zone2

# Turn On the Office AC Vent when there is motion for more than 3 minutes in the office
- id: officeacon3min
  alias: Turn on Office vent when there is motion for more than 3 minutes
  trigger: 
    - platform: state
      entity_id: group.office_motion
      to: 'on'
      for: 
        minutes: 3
    - platform: state
      entity_id: sensor.myair_state
      from: 'off'
      to: 'on'
      for:
        seconds: 90
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.zone_off_auto
        state: 'on'
      - condition: state
        entity_id: sensor.myair_state
        state: 'on'
      - condition: state
        entity_id: group.office_motion
        state: 'on'
      - condition: state
        entity_id: switch.myair_zone2
        state: 'off'
  action:
    - service: switch.turn_on
      entity_id:  switch.myair_zone2


# Turn on the living dim light (light strips and lamps) when there is motion in kitchen/living and when time is between sunset and midnight. 
- id: turnonlivingdimlights
  alias: Turn on the living dim light (light strips and lamps) when there is motion in kitchen/living and when time is between sunset and midnight. 
  initial_state: True
  trigger:
    - platform: state
      entity_id: group.living_kitchen_motion
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: sun
        after: sunset
      - condition: time
        before: '23:59:59'
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
  action:
    - service: homeassistant.turn_on
      entity_id: light.dining_floor_lamp
    - service: homeassistant.turn_on
      entity_id: light.living_floor_lamp
    - service: homeassistant.turn_on
      entity_id: light.hue_lightstrip_plus_1
    - service: homeassistant.turn_on
      entity_id: light.hue_lightstrip_plus_1_2

# Turn off the living mood dim lights at mid night
- id: turnofflivingdimlights
  alias: Turn on the living mood dim light at midnight
  initial_state: True
  trigger:
    - platform: time
      at: 23:58:59
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: input_boolean.light_off_auto
        state: 'on'
      - condition: or
        conditions:
          - condition: state
            entity_id: light.dining_floor_lamp
            state: 'on'
          - condition: state
            entity_id: light.living_floor_lamp
            state: 'on'
          - condition: state
            entity_id: light.hue_lightstrip_plus_1
            state: 'on'
          - condition: state
            entity_id: light.hue_lightstrip_plus_1_2
            state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id: light.dining_floor_lamp
    - service: homeassistant.turn_off
      entity_id: light.living_floor_lamp
    - service: homeassistant.turn_off
      entity_id: light.hue_lightstrip_plus_1
    - service: homeassistant.turn_off
      entity_id: light.hue_lightstrip_plus_1_2

# Turn off the Living Sonos (if playing) when the TV is switched on
- id: turnofflivingsonoswhentvon
  alias: Turn off the Living Sonos (if playing) when the TV is switched on
  trigger: 
    - platform: state
      entity_id: media_player.yamaha_receiver
      to: 'on'
  condition:
    condition: state
    entity_id: media_player.living
    state: 'playing'
  action:
    service: media_player.media_play_pause
    entity_id: media_player.living

# Toggle Living Mood lights when Xiaomi Living push button is single pressed
- id: togglelivingmoodlightspushbutton
  alias: Toggle Living Mood lights when Xiaomi Living push button is single pressed
  trigger: 
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000323d424
      click_type: single
  action:
    service: light.toggle
    entity_id: light.living_mood_lights

# Toggle Living Sonos when Xiaomi Living push button is double pressed
- id: togglelivingsonospushbuttondouble
  alias: Toggle Living Sonos when Xiaomi Living push button is double pressed
  trigger: 
    platform: event
    event_type: xiaomi_aqara.click
    event_data:
      entity_id: binary_sensor.switch_158d000323d424
      click_type: double
  action:
    service: media_player.media_play_pause
    entity_id: media_player.living

# Alarm when there is motion outside master bedroom and when the night mood is on
- id: alarmwhennightmood
  alias: Alarm when there is motion outside master bedroom and when the night mood is on
  trigger: 
      # Kitchen-M2  
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002742898
        to: 'on'
      # Living-M
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002c716b6
        to: 'on'
      # Main Door
      - platform: state
        entity_id: binary_sensor.door_window_sensor_158d0002739295
        to: 'on'
      # Garage-M2
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002c716d7
        to: 'on'
      # Loundry Door
      - platform: state
        entity_id: binary_sensor.door_window_sensor_158d0002ca3100
        to: 'on'
      # Office-M2
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002b7ec00
        to: 'on'
      # Alfresco-M
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0002b5eecd
        to: 'on'
        for:
          seconds: 125
      # Garage Entry door
      - platform: state
        entity_id: binary_sensor.door_window_sensor_158d00033a7262
        to: 'on'
      # Garage door
      - platform: state
        entity_id: binary_sensor.door_window_sensor_158d0002c0e236
        to: 'on'
      # Laundry Motion
      - platform: state
        entity_id: binary_sensor.laundry_199
        to: 'on'
      # Room 4 Motion
      - platform: state
        entity_id: binary_sensor.room4_194
        to: 'on'
  condition:
    condition: state
    entity_id: input_boolean.night_mood
    state: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: script.xiaomi_gateway_alarm
    - service: notify.pushbullet
      data_template:
        title: '{{ trigger.to_state.attributes.friendly_name }} Motion Detected while night mood is on -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  '{{ trigger.to_state.attributes.friendly_name }} Motion Detected while night mood is on -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
    - service: notify.sendgrid
      data_template:
        title: '{{ trigger.to_state.attributes.friendly_name }} Motion Detected while night mood is on -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'
        message:  '{{ trigger.to_state.attributes.friendly_name }} Motion Detected while night mood is on -  {{now().strftime("%m/%d/%Y - %I:%M %p")}}'

# Turn on Bed Heater at 10pm if the master bedroom temperature is below 22C
- id: turnonbedheaterelow22c
  alias: Turn on Bed Heater at 10pm if the master bedroom temperature is below 22C
  initial_state: True
  trigger:
    - platform: time
      at: '22:00:00'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: switch.bedheater_38
        state: 'off'
      - condition: numeric_state
        entity_id: sensor.m_bed_room_t_34
        below: 22
  action:
    - service : switch.turn_on
      entity_id: switch.bedheater_38

# Turn off Bed Heater automatically after two hours
- id: turnoffbedheater2hours
  alias: Turn off Bed Heater automatically after two hours
  initial_state: True
  trigger: 
    - platform: state
      entity_id: switch.bedheater_38
      to: 'on'
      for:
        hours: 2
  condition:
    condition: state
    entity_id: switch.bedheater_38
    state: 'on'
  action:
    - service: switch.turn_off
      entity_id: switch.bedheater_38

# Turn on the night mood at midnight when there is no motion in the house
- id: turnonnightmoodatmidnight
  alias: Turn on the night mood at midnight when there is no motion in the house
  initial_state: True
  trigger:
    - platform: time
      at: 23:59:59
    - platform: time
      at: 01:00:00
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: group.garage_motion
        state: 'off'
      - condition: state
        entity_id: group.living_kitchen_motion
        state: 'off'
      - condition: state
        entity_id: light.kitchen_light_135
        state: 'off'
      - condition: state
        entity_id: light.dining_floor_lamp
        state: 'off'
      - condition: state
        entity_id: group.office_motion
        state: 'off'
      - condition: state
        entity_id: binary_sensor.door_window_sensor_158d0003677216
        state: 'off'
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: switch.nightmood
        state: 'off'
      - condition: state
        entity_id: input_boolean.nightmood_auto
        state: 'on'
  action:
    - service: homeassistant.turn_on
      entity_id: switch.nightmood

# Turn off the Night mood when master bedroom door open in the morning
- id: turnoffnightmoodmorning
  alias: Turn off the Night mood when master bedroom door open in the morning
  trigger: 
    - platform: state
      entity_id: binary_sensor.door_window_sensor_158d0003677216
      to: 'on'
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: switch.housealarm
        state: 'off'
      - condition: state
        entity_id: switch.nightmood
        state: 'on'
      - condition: state
        entity_id: input_boolean.nightmood_auto
        state: 'on'
  action:
    - service: homeassistant.turn_off
      entity_id: switch.nightmood